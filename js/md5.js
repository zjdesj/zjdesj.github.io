//2013-4-12 16:33 wyw
(function(){function o(e){e.stopPropagation(),e.preventDefault()}function u(e,i,s,o){var u=document.createElement("div");u.innerHTML=e,u.className="alert-message"+(i?" "+i:""),s=="s"?$(n).find(".groupdiv")[o].appendChild(u):s=="t"?$(t).find(".groupdiv")[o].appendChild(u):r.appendChild(u)}function a(){var e=navigator.userAgent.toLowerCase();if(/chrome/.test(e))location.protocol==="file:"&&u('<p><strong>This example will only work in chrome (in file:// protocol) if you start it up with -allow-file-access-from-files argument.</strong><br/>This is a security measure introduced in chrome, please <a target="_blank" href="http://code.google.com/p/chromium/issues/detail?id=60889">see</a>.</p>');else if(/firefox/.test(e)){var t=!!window.console&&!!(window.console.firebug||console.exception&&console.table);t&&u("<p>\u63a5\u4e0b\u6765\u7684\u4e00\u6bb5\u65f6\u95f4\uff0c\u4f60\u4f1a\u53d1\u73b0firefox\u5361\u5c4e\u4e86\u3002\u90a3\u662f\u56e0\u4e3a\u4f60<strong>\u5f00\u542f\u4e86firebug</strong>\u3002<br/>\u5173\u95ed\u4e86firebug\u91cd\u8bd5\u5427\u3002^_^</p>")}else/opera/.test(e)&&u("<p><strong>\u5173\u95ed DragonFly \u53ef\u5927\u5927\u63d0\u5347\u901f\u5ea6\u3002</strong></p>")}function f(e){e.stopPropagation(),e.preventDefault(),h(),a();var t=p();t==3?($("#slog").addClass("half"),$("#tlog").addClass("half"),l(),c()):t==2?l():t==1?c():u("<p><strong>\u603b\u5f97\u9009\u4e2a\u65b9\u5f0f\u628a\uff0c\u4e0d\u9009\u6211\u600e\u4e48\u7b97...</strong></p>")}function l(t){if(i.files.length==0){u("<strong>\u9009\u62e9\u6587\u4ef6\u554a\uff0c\u5e72\u561b\u5462\uff01</strong><br/>");return}for(var r=0;r<i.files.length;r++)(function(t){function v(){var t=l*a,n=t+a>=o.size?o.size:t+a;s.readAsBinaryString(e.call(o,t,n))}var r=document.createElement("div");r.setAttribute("class","groupdiv"),n.appendChild(r);var s=new FileReader,o=i.files[t],a=2097152,f=Math.ceil(o.size/a),l=0,c=new SparkMD5,h,p="chunk_"+(new Date).getTime(),d=null;s.onload=function(e){l==0?u('\u6b63\u5728\u8bfb\u53d6\u7b2c\uff1a <strong id="'+p+'">'+(l+1)+"</strong>\u5757\uff0c\u5171 <strong>"+f+"</strong>\u5757\u3002<br/>","info","s",t):(d===null&&(d=document.getElementById(p)),d.innerHTML=l+1),c.appendBinary(e.target.result),l++,l<f?v():(u("<strong>\u6587\u4ef6\u8bfb\u53d6\u5b8c\u6bd5\uff01</strong><br/>","success","s",t),u("<strong>\u8ba1\u7b97\u51fa\u7684MD5:</strong> "+c.end()+"<br/>","success","s",t),u("<strong>\u8017\u65f6:</strong> "+((new Date).getTime()-h)+"ms<br/>","success","s",t))},s.onerror=function(){u("<strong>**\uff0c\u54ea\u51fa\u9519\u4e86...</strong>","error","s",t)},u("<p></p><strong>\u5206\u5757\u8bfb\u53d6</strong><br/>","title","s",t),u("<p></p><strong>\u6587\u4ef6\uff1a ("+o.name+")</strong><br/>","info","s",t),h=(new Date).getTime(),v()})(r)}function c(){if(i.files.length==0){u("<strong>\u9009\u4e2a\u6587\u4ef6\u5427\uff0c\u4eb2\uff01</strong><br/>");return}for(var e=0;e<i.files.length;e++)(function(e){var n=document.createElement("div");n.setAttribute("class","groupdiv"),t.appendChild(n);var r=new FileReader,s=i.files[0],o;r.onload=function(t){u("<strong>\u5168\u6587\u4ef6\u52a0\u8f7d\u5b8c\u6bd5!</strong><br/>","success","t",e),u("<strong>MD5\uff1a</strong> "+SparkMD5.hashBinary(t.target.result)+"<br/>","success","t",e),u("<strong>\u8017\u65f6\uff1a</strong> "+((new Date).getTime()-o)+"ms<br/>","success","t",e)},r.onerror=function(t){u("<strong>ERROR:</strong> FileReader\u51fa\u9519\u4e86\u3002\u7406\u8bba\u4e0a\u6765\u8bf4\u4f60\u7684\u5185\u5b58\u6761\u592a\u5c0f\u4e86\u3002<br/>","error","t",e)},u("<strong>\u5168\u6587\u4ef6\u8bfb\u53d6</strong><br/>","title","t",e),u("<strong>\u6587\u4ef6\u540d\uff1a("+s.name+")</strong><br/>","info","t",e),o=(new Date).getTime(),r.readAsBinaryString(s)})(e)}function h(){$(".log div").remove()}function p(){var e=0;return $("#check input").each(function(t,n){e+=parseInt($(n).val())}),e}$("#check input").each(function(e,t){$(t).bind("click",function(){$(this).val()==0?$(this).attr("value",e+1):$(this).attr("value",0)})});var e=File.prototype.slice||File.prototype.mozSlice||File.prototype.webkitSlice,t=document.getElementById("tlog"),n=document.getElementById("slog"),r=document.getElementById("alog"),i=document.getElementById("files"),s=document.getElementById("drop_zone");s.onclick=function(){return document.getElementById("files").click(),!1},s.addEventListener("dragover",o,!1),s.addEventListener("drop",f,!1),document.getElementById("files").addEventListener("change",f,!1),(!("FileReader"in window)||!("File"in window)||!e)&&u("<p><strong>Your browser does not support the FileAPI or slicing of files.</strong></p>","error"),typeof File!="undefined"&&!File.prototype.slice&&(File.prototype.webkitSlice&&(File.prototype.slice=File.prototype.webkitSlice),File.prototype.mozSlice&&(File.prototype.slice=File.prototype.mozSlice))})();

